# HTTP Gateway é«˜çº§ç¤ºä¾‹
# å±•ç¤º Gateway æ’ä»¶çš„å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬ HMAC è®¤è¯ã€å¤šè·¯ç”±é…ç½®ç­‰

name: "HTTP Gateway Advanced Demo"

global:
  # å®‰å…¨é…ç½®
  hmacSecret: "advanced-secret-key-2024"
  # API é…ç½®
  apiConfig: {
    baseUrl: "https://api.example.com",
    timeout: 5000
  }

nodes:
  # 1. HTTP Gateway è§¦å‘å™¨ - é«˜çº§é…ç½®
  - name: "AdvancedGateway"
    type: "http_gateway"
    parameters:
      # HTTP ç›‘å¬ç«¯å£
      http_port: "8081"
      # è·¯ç”±é…ç½® - JSON æ ¼å¼ï¼ˆæ›´çµæ´»ï¼‰
      routes_json: |
        [
          {
            "path": "/api/v2/users",
            "methods": ["POST", "GET"],
            "target_workflow": "HTTP Gateway Advanced Demo"
          },
          {
            "path": "/api/v2/products/:id",
            "methods": ["GET", "PUT", "DELETE"],
            "target_workflow": "HTTP Gateway Advanced Demo"
          },
          {
            "path": "/api/v2/webhook/*",
            "methods": ["ANY"],
            "target_workflow": "HTTP Gateway Advanced Demo"
          }
        ]
      # HMAC è®¤è¯é…ç½®
      hmac_secret: "={{ $global.hmacSecret }}"
      # ç­¾åå¤´é…ç½®
      signature_header: "X-Gateway-Signature"
      timestamp_header: "X-Gateway-Timestamp"
      # æ—¶é—´æˆ³åå·®ï¼ˆæ¯«ç§’ï¼‰
      timestamp_skew_ms: "60000"

  # 2. HMAC ç­¾åéªŒè¯
  - name: "VerifyHMAC"
    type: "js"
    parameters:
      input:
        triggerPayload: "={{ $global.TRIGGER.payload }}"
      code: |
        const { triggerPayload } = input;
        const payload = triggerPayload;
        console.log("ğŸ” å¼€å§‹ HMAC éªŒè¯...");
        
        // HMAC éªŒè¯åœ¨æ’ä»¶å†…éƒ¨å·²å®Œæˆï¼Œè¿™é‡Œä»…åšé¢å¤–éªŒè¯
        const headers = payload.headers || {};
        const signature = headers['X-Gateway-Signature'] || '';
        const timestamp = headers['X-Gateway-Timestamp'] || '';
        
        if (!signature || !timestamp) {
          throw new Error('Missing signature or timestamp');
        }
        
        console.log("âœ… HMAC éªŒè¯é€šè¿‡");
        
        return {
          hmacVerified: true,
          signature: signature,
          timestamp: timestamp,
          payload: payload
        };

  # 3. è§£æè¯·æ±‚å‚æ•°
  - name: "ParseParams"
    type: "js"
    parameters:
      code: |
        const data = input;
        const payload = data.payload;
        
        // è§£æè¯·æ±‚æ•°æ®
        const method = payload.method;
        const path = payload.path;
        const body = payload.body || {};
        const query = payload.query || {};
        
        // è§£æè·¯å¾„å‚æ•°ï¼ˆç¤ºä¾‹ï¼‰
        const pathParts = path.split('/');
        let pathParams = {};
        
        // å¤„ç† /api/v2/products/:id æ ¼å¼çš„è·¯å¾„
        if (path.startsWith('/api/v2/products/')) {
          pathParams = {
            productId: pathParts[4] || ''
          };
        }
        
        // å¤„ç† /api/v2/webhook/* æ ¼å¼çš„è·¯å¾„
        if (path.startsWith('/api/v2/webhook/')) {
          pathParams = {
            webhookType: pathParts[4] || '',
            webhookId: pathParts[5] || ''
          };
        }
        
        return {
          method: method,
          path: path,
          body: body,
          query: query,
          pathParams: pathParams,
          fullUrl: `http://localhost:8081${path}`
        };

  # 4. è¯·æ±‚åˆ†ç±»
  - name: "ClassifyRequest"
    type: "js"
    parameters:
      code: |
        const request = input;
        
        let category = "unknown";
        let action = "unknown";
        
        // åˆ†ç±»é€»è¾‘
        if (request.path.startsWith('/api/v2/users')) {
          category = "users";
          action = request.method === "POST" ? "create_user" : "get_users";
        } else if (request.path.startsWith('/api/v2/products')) {
          category = "products";
          if (request.method === "GET") {
            action = "get_product";
          } else if (request.method === "PUT") {
            action = "update_product";
          } else if (request.method === "DELETE") {
            action = "delete_product";
          }
        } else if (request.path.startsWith('/api/v2/webhook')) {
          category = "webhook";
          action = `webhook_${request.pathParams.webhookType || 'unknown'}`;
        }
        
        return {
          category: category,
          action: action,
          ...request
        };

  # 5. ç”¨æˆ·ç®¡ç†å¤„ç†
  - name: "HandleUserRequest"
    type: "js"
    parameters:
      code: |
        const request = input;
        
        if (request.action === "create_user") {
          // æ¨¡æ‹Ÿåˆ›å»ºç”¨æˆ·
          const user = {
            id: `USER-${Date.now()}`,
            ...request.body,
            createdAt: new Date().toISOString(),
            status: "active"
          };
          
          return {
            success: true,
            user: user,
            message: "User created successfully"
          };
        } else {
          // æ¨¡æ‹Ÿè·å–ç”¨æˆ·åˆ—è¡¨
          const users = [
            { id: "USER-1", name: "User 1", email: "user1@example.com" },
            { id: "USER-2", name: "User 2", email: "user2@example.com" }
          ];
          
          return {
            success: true,
            users: users,
            count: users.length,
            message: "Users retrieved successfully"
          };
        }

  # 6. äº§å“ç®¡ç†å¤„ç†
  - name: "HandleProductRequest"
    type: "js"
    parameters:
      code: |
        const request = input;
        const productId = request.pathParams.productId;
        
        switch (request.action) {
          case "get_product":
            return {
              success: true,
              product: {
                id: productId,
                name: `Product ${productId}`,
                price: 99.99,
                stock: 100
              },
              message: "Product retrieved successfully"
            };
          
          case "update_product":
            return {
              success: true,
              product: {
                id: productId,
                ...request.body,
                updatedAt: new Date().toISOString()
              },
              message: "Product updated successfully"
            };
          
          case "delete_product":
            return {
              success: true,
              deletedId: productId,
              message: "Product deleted successfully"
            };
          
          default:
            return {
              success: false,
              error: "Unknown product action",
              code: 400
            };
        }

  # 7. Webhook å¤„ç†
  - name: "HandleWebhook"
    type: "js"
    parameters:
      code: |
        const request = input;
        const webhookType = request.pathParams.webhookType;
        
        console.log(`ğŸ“¡ å¤„ç† Webhook: ${webhookType}`);
        console.log("ğŸ“‹ Webhook æ•°æ®:", JSON.stringify(request.body, null, 2));
        
        // æ¨¡æ‹Ÿä¸åŒç±»å‹çš„ webhook å¤„ç†
        let result = {
          success: true,
          webhookType: webhookType,
          processedAt: new Date().toISOString(),
          data: request.body
        };
        
        if (webhookType === "payment") {
          // æ”¯ä»˜ webhook å¤„ç†
          result.paymentStatus = request.body.status || "pending";
          result.transactionId = request.body.transactionId || "";
        } else if (webhookType === "shipping") {
          // ç‰©æµ webhook å¤„ç†
          result.shippingStatus = request.body.status || "processing";
          result.trackingNumber = request.body.trackingNumber || "";
        }
        
        return result;

  # 8. ç»Ÿä¸€å“åº”æ„å»º
  - name: "BuildResponse"
    type: "js"
    parameters:
      code: |
        const result = input;
        
        // æ ¹æ®å¤„ç†ç»“æœæ„å»ºç»Ÿä¸€å“åº”
        let response = {
          success: result.success || false,
          timestamp: new Date().toISOString(),
          requestId: `REQ-${Date.now()}`
        };
        
        if (result.success) {
          response.message = result.message || "Request processed successfully";
          
          // æ ¹æ®ä¸åŒç±»å‹æ·»åŠ æ•°æ®
          if (result.user) response.user = result.user;
          if (result.users) response.users = result.users;
          if (result.product) response.product = result.product;
          if (result.deletedId) response.deletedId = result.deletedId;
          if (result.webhookType) response.webhook = result;
        } else {
          response.message = result.message || "Request failed";
          response.error = result.error || "Unknown error";
          response.code = result.code || 500;
        }
        
        console.log("ğŸ“¤ æ„å»ºæœ€ç»ˆå“åº”:", JSON.stringify(response, null, 2));
        
        return response;

connections:
  AdvancedGateway:
    - - { node: "VerifyHMAC" }
  VerifyHMAC:
    - - { node: "ParseParams" }
  ParseParams:
    - - { node: "ClassifyRequest" }
  ClassifyRequest:
    # æ ¹æ®åˆ†ç±»è·¯ç”±åˆ°ä¸åŒå¤„ç†èŠ‚ç‚¹
    - - { node: "HandleUserRequest", when: [{ value1: "={{ $P.category }}", operation: "==", value2: "users" }] }
    - - { node: "HandleProductRequest", when: [{ value1: "={{ $P.category }}", operation: "==", value2: "products" }] }
    - - { node: "HandleWebhook", when: [{ value1: "={{ $P.category }}", operation: "==", value2: "webhook" }] }
  HandleUserRequest:
    - - { node: "BuildResponse" }
  HandleProductRequest:
    - - { node: "BuildResponse" }
  HandleWebhook:
    - - { node: "BuildResponse" }
