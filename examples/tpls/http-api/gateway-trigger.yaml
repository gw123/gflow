# HTTP Gateway è§¦å‘å·¥ä½œæµç¤ºä¾‹
# å½“å¤–éƒ¨ç³»ç»Ÿå‘é€è¯·æ±‚åˆ° Gateway ç«¯ç‚¹æ—¶è§¦å‘

name: "HTTP Gateway Trigger Demo"

global:
  apiKey: "gateway-secret-123"
  targetUrl: "https://api.example.com/process"

nodes:
  # 1. HTTP Gateway è§¦å‘å™¨ - ç›‘å¬å¤–éƒ¨è¯·æ±‚
  - name: "GatewayReceiver"
    type: "http_gateway"
    parameters:
      # HTTP ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ 8080
      http_port: "8080"
      # è·¯ç”±é…ç½®ï¼Œæ”¯æŒå¤šç§æ ¼å¼
      # æ ¼å¼1: é€—å·åˆ†éš”ï¼Œå¦‚ "POST:/webhook,GET:/notify"
      routes: "POST:/api/v1/orders,GET:/api/v1/status"
      # å¯é€‰ï¼šAPI Key è®¤è¯
      api_key: "={{ $global.apiKey }}"
      # å¯é€‰ï¼šé»˜è®¤ç›®æ ‡å·¥ä½œæµ
      target_workflow: "HTTP Gateway Trigger Demo"

  # 2. è§£æå’ŒéªŒè¯è¯·æ±‚
  - name: "ParseRequest"
    type: "js"
    parameters:
      input:
        triggerPayload: "={{ $global.TRIGGER.payload }}"
        apiKey: "={{ $global.apiKey }}"
      code: |
        const { triggerPayload, apiKey } = input;
        // è·å– Gateway è¯·æ±‚æ•°æ®
        const payload = triggerPayload;
        console.log("ğŸ“¥ Gateway è¯·æ±‚æ•°æ®:", JSON.stringify(payload, null, 2));
        
        // éªŒè¯ API Key
        const headers = payload.headers || {};
        const receivedKey = headers['X-API-Key'] || '';
        const expectedKey = apiKey;
        
        if (receivedKey !== expectedKey) {
          throw new Error('Invalid API Key');
        }
        
        // è§£æè¯·æ±‚æ•°æ®
        const method = payload.method;
        const path = payload.path;
        const body = payload.body || {};
        const query = payload.query || {};
        
        return {
          valid: true,
          method: method,
          path: path,
          body: body,
          query: query,
          receivedAt: new Date().toISOString()
        };

  # 3. æ ¹æ®è¯·æ±‚æ–¹æ³•å’Œè·¯å¾„å¤„ç†
  - name: "RouteRequest"
    type: "js"
    parameters:
      code: |
        const request = input;
        
        // æ ¹æ®æ–¹æ³•å’Œè·¯å¾„è·¯ç”±
        if (request.method === 'POST' && request.path === '/api/v1/orders') {
          return {
            action: "create_order",
            data: request.body,
            route: "order_creation"
          };
        } else if (request.method === 'GET' && request.path === '/api/v1/status') {
          return {
            action: "check_status",
            orderId: request.query.orderId || "",
            route: "status_check"
          };
        } else {
          return {
            action: "unknown",
            route: "unknown",
            message: `Unknown request: ${request.method} ${request.path}`
          };
        }

  # 4a. å¤„ç†è®¢å•åˆ›å»º
  - name: "CreateOrder"
    type: "js"
    parameters:
      code: |
        const orderData = input.data;
        
        // æ¨¡æ‹Ÿè®¢å•åˆ›å»ºé€»è¾‘
        const order = {
          id: `ORD-${Date.now()}`,
          ...orderData,
          status: "pending",
          createdAt: new Date().toISOString()
        };
        
        console.log("ğŸ“¦ åˆ›å»ºè®¢å•:", JSON.stringify(order, null, 2));
        
        return {
          success: true,
          order: order,
          message: "Order created successfully"
        };

  # 4b. å¤„ç†çŠ¶æ€æŸ¥è¯¢
  - name: "CheckStatus"
    type: "js"
    parameters:
      code: |
        const orderId = input.orderId;
        
        // æ¨¡æ‹ŸçŠ¶æ€æŸ¥è¯¢é€»è¾‘
        if (!orderId) {
          return {
            success: false,
            error: "Order ID is required"
          };
        }
        
        // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€
        const status = {
          orderId: orderId,
          status: "processing",
          updatedAt: new Date().toISOString(),
          tracking: "TRK-123456"
        };
        
        console.log("ğŸ” æŸ¥è¯¢çŠ¶æ€:", JSON.stringify(status, null, 2));
        
        return {
          success: true,
          status: status
        };

  # 4c. å¤„ç†æœªçŸ¥è¯·æ±‚
  - name: "HandleUnknown"
    type: "js"
    parameters:
      code: |
        const request = input;
        
        console.log("âš ï¸ æœªçŸ¥è¯·æ±‚:", request.message);
        
        return {
          success: false,
          error: request.message,
          code: 404
        };

  # 5. å‘é€åˆ°å¤–éƒ¨ API
  - name: "SendToAPI"
    type: "js"
    parameters:
      input:
        result: "={{ $P }}"
        targetUrl: "={{ $global.targetUrl }}"
      code: |
        const { result, targetUrl } = input;
        
        // æ¨¡æ‹Ÿå‘é€åˆ°å¤–éƒ¨ API
        console.log(`ğŸ“¤ å‘é€åˆ°å¤–éƒ¨ API: ${targetUrl}`);
        console.log("ğŸ“‹ å‘é€æ•°æ®:", JSON.stringify(result, null, 2));
        
        // æ¨¡æ‹Ÿ API å“åº”
        const apiResponse = {
          externalId: `EXT-${Date.now()}`,
          processedAt: new Date().toISOString(),
          ...result
        };
        
        return {
          apiResponse: apiResponse,
          sentToAPI: true
        };

  # 6. æ„å»ºå“åº”
  - name: "BuildResponse"
    type: "js"
    parameters:
      code: |
        const finalResult = input;
        
        // æ„å»ºæœ€ç»ˆå“åº”
        let response = {
          success: finalResult.apiResponse?.success || false,
          message: finalResult.apiResponse?.message || "Request processed",
          timestamp: new Date().toISOString()
        };
        
        if (finalResult.apiResponse?.order) {
          response.order = finalResult.apiResponse.order;
        } else if (finalResult.apiResponse?.status) {
          response.status = finalResult.apiResponse.status;
        } else if (finalResult.apiResponse?.error) {
          response.error = finalResult.apiResponse.error;
        }
        
        console.log("ğŸ“¤ æœ€ç»ˆå“åº”:", JSON.stringify(response, null, 2));
        
        return response;

connections:
  GatewayReceiver:
    - - { node: "ParseRequest" }
  ParseRequest:
    - - { node: "RouteRequest" }
  RouteRequest:
    # æ ¹æ®è¯·æ±‚ç±»å‹è·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹
    - - { node: "CreateOrder", when: [{ value1: "={{ $P.action }}", operation: "==", value2: "create_order" }] }
    - - { node: "CheckStatus", when: [{ value1: "={{ $P.action }}", operation: "==", value2: "check_status" }] }
    - - { node: "HandleUnknown", when: [{ value1: "={{ $P.action }}", operation: "==", value2: "unknown" }] }
  CreateOrder:
    - - { node: "SendToAPI" }
  CheckStatus:
    - - { node: "SendToAPI" }
  HandleUnknown:
    - - { node: "SendToAPI" }
  SendToAPI:
    - - { node: "BuildResponse" }
