name: gateway-trigger-example

nodes:
  - name: GatewayReceiver
    type: trigger
    plugin: http_gateway
    filters:
      http_port: "8080"
      routes: "POST:/webhook,GET:/notify"
      api_key: "test-api-key-123"
    global:
      TRIGGER: "={{ $P }}"
      apiKey: "={{ $P.api_key }}"

  - name: ParseRequest
    type: javascript
    parameters:
      input:
        triggerPayload: "={{ $global.TRIGGER.payload }}"
        apiKey: "={{ $global.apiKey }}"
      code: |
        const { triggerPayload, apiKey } = input;
        
        console.log('Received request:', triggerPayload);
        console.log('API Key:', apiKey);
        
        const result = {
          method: triggerPayload.method,
          path: triggerPayload.path,
          body: triggerPayload.body,
          headers: triggerPayload.headers,
          query: triggerPayload.query,
          isValid: triggerPayload.headers['x-api-key'] === apiKey
        };
        
        return result;
    global:
      requestInfo: "={{ $P }}"
      isValidRequest: "={{ $P.isValid }}"

  - name: ProcessValidRequest
    type: javascript
    parameters:
      input:
        requestInfo: "={{ $global.requestInfo }}"
        isValid: "={{ $global.isValidRequest }}"
      code: |
        const { requestInfo, isValid } = input;
        
        if (!isValid) {
          return {
            status: 401,
            message: "Unauthorized: Invalid API Key",
            processed: false
          };
        }
        
        // Process valid request
        const processedData = {
          message: "Request processed successfully",
          data: requestInfo.body,
          timestamp: new Date().toISOString(),
          requestId: Math.random().toString(36).substr(2, 9)
        };
        
        return {
          status: 200,
          message: "OK",
          processed: true,
          data: processedData
        };
    global:
      processingResult: "={{ $P }}"

  - name: SendResponse
    type: javascript
    parameters:
      input:
        processingResult: "={{ $global.processingResult }}"
      code: |
        const { processingResult } = input;
        
        console.log('Sending response:', processingResult);
        
        // Prepare response for the gateway
        return {
          status: processingResult.status,
          headers: {
            'Content-Type': 'application/json',
            'X-Processed': processingResult.processed ? 'true' : 'false'
          },
          body: {
            message: processingResult.message,
            ...(processingResult.data && { data: processingResult.data })
          }
        };

connections:
  GatewayReceiver:
    - - node: ParseRequest
  ParseRequest:
    - - node: ProcessValidRequest
  ProcessValidRequest:
    - - node: SendResponse
