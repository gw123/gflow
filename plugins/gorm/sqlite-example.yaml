id: "sqlite-db-operator-example-1"
name: "SQLite DB Operator Workflow"
content:
  name: "SQLite DB Operator Workflow"
  global:
    apiKey: "test-api-key-123"
    driver: "sqlite"
    dsn: "file:test.db?cache=shared&_fk=1"
    alias: "sqlite_test"

  nodes:
    - name: "ManualTrigger"
      type: "http_gateway"
      parameters:
        http_port: "8081"
        routes: "POST:/sqlite-run"
        api_key: "={{ $global.apiKey }}"

    - name: "InitUsersTable"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "raw"
        raw_sql: |
          CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT,
            status TEXT,
            shop_id INTEGER,
            created_at TEXT
          );

    - name: "InitOrdersTable"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "raw"
        raw_sql: |
          CREATE TABLE IF NOT EXISTS orders (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            amount REAL,
            status TEXT,
            created_at TEXT
          );

    - name: "InsertUsers"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "create"
        table: "users"
        create_data:
          - { name: "Alice", status: "active", shop_id: 1, created_at: "2025-01-01T10:00:00Z" }
          - { name: "Bob", status: "active", shop_id: 1, created_at: "2025-01-02T11:00:00Z" }
          - { name: "Carol", status: "inactive", shop_id: 2, created_at: "2025-01-03T12:00:00Z" }

    - name: "InsertOrders"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "create"
        table: "orders"
        create_data:
          - { user_id: 1, amount: 1200.50, status: "paid", created_at: "2025-01-04T09:00:00Z" }
          - { user_id: 1, amount: 300.00, status: "paid", created_at: "2025-01-05T10:00:00Z" }
          - { user_id: 2, amount: 150.75, status: "paid", created_at: "2025-01-06T11:00:00Z" }
          - { user_id: 2, amount: 50.00, status: "cancelled", created_at: "2025-01-07T12:00:00Z" }

    - name: "JoinQuery"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "find"
        table: "orders"
        table_alias: "o"
        select: ["o.id","u.name AS user_name","o.amount","o.status","o.created_at"]
        joins:
          - { type: "left", table: "users", alias: "u", on: { expr: "u.id = o.user_id AND u.status = ?", values: ["active"] } }
        where:
          - { field: "o.status", op: "eq", value: "paid" }
        order_by:
          - { field: "o.created_at", dir: "desc" }
        page: 1
        page_size: 10
        calc_total: true
        debug: { print: true, capture: true, level: "info", slow_threshold_ms: 200 }

    - name: "Aggregate"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "aggregate"
        table: "orders"
        where:
          - { expr: "created_at BETWEEN ? AND ?", values: ["2025-01-01","2025-12-31"] }
        aggregations:
          - { func: "sum", field: "amount", alias: "sum_amount" }
        debug: { capture: true }

    - name: "UpdateUser"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "update"
        table: "users"
        where:
          - { field: "id", op: "eq", value: 1 }
        update_data:
          status: "inactive"

    - name: "DeleteCancelled"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "delete"
        table: "orders"
        where:
          - { field: "status", op: "eq", value: "cancelled" }

    - name: "RawSelectUsers"
      type: "db_operator"
      parameters:
        driver: "={{ $global.driver }}"
        dsn: "={{ $global.dsn }}"
        alias: "={{ $global.alias }}"
        op: "raw"
        raw_sql: "SELECT id, name, status FROM users ORDER BY id ASC"
        #raw_sql: "SELECT * FROM users ORDER BY id ASC"
        debug: { capture: true }

    - name: "ReturnResponse"
      type: "response"
      parameters:
        status_code: "200"
        body: |
          {
            "success": true,
            "result": {{ $P.output }},
            "metadata": {
              "workflow": "{{ $WORKFLOW.name }}",
              "node": "{{ $NODE.name }}"
            }
          }
        headers:
          Content-Type: "application/json"
          X-Response-From: "sqlite-db-operator-example"

  connections:
    ManualTrigger:
      - - { node: "InitUsersTable" }
    InitUsersTable:
      - - { node: "InitOrdersTable" }
    InitOrdersTable:
      - - { node: "InsertUsers" }
    InsertUsers:
      - - { node: "InsertOrders" }
    InsertOrders:
      - - { node: "JoinQuery" }
    JoinQuery:
      - - { node: "Aggregate" }
    Aggregate:
      - - { node: "UpdateUser" }
    UpdateUser:
      - - { node: "DeleteCancelled" }
    DeleteCancelled:
      - - { node: "RawSelectUsers" }
    RawSelectUsers:
      - - { node: "ReturnResponse" }
updatedAt: "2025-12-13T00:00:00.000Z"
