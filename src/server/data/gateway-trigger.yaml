id: "gateway-trigger-1"
name: "HTTP Gateway Trigger Demo"
content:
  name: "HTTP Gateway Trigger Demo"
  global:
    apiKey: "gateway-secret-123"
    targetUrl: "https://api.example.com/process"
  
  nodes:
    # 1. HTTP Gateway è§¦å‘å™¨ - ç›‘å¬å¤–éƒ¨è¯·æ±‚
    - name: "GatewayReceiver"
      type: "http_gateway"
      parameters:
        # HTTP ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ 8080
        http_port: "8080"
        # è·¯ç”±é…ç½®ï¼Œæ”¯æŒå¤šç§æ ¼å¼
        # æ ¼å¼1: é€—å·åˆ†éš”ï¼Œå¦‚ "POST:/webhook,GET:/notify"
        routes: "POST:/api/v1/orders,GET:/api/v1/status"
        # å¯é€‰ï¼šAPI Key è®¤è¯
        api_key: "={{ $global.apiKey }}"
        # å¯é€‰ï¼šé»˜è®¤ç›®æ ‡å·¥ä½œæµ
        target_workflow: "HTTP Gateway Trigger Demo"

    # 2. è§£æå’ŒéªŒè¯è¯·æ±‚
    - name: "ParseRequest"
      type: "js"
      parameters:
        input:
          triggerPayload: "={{ $global.TRIGGER.payload }}"
          apiKey: "={{ $global.apiKey }}"
        code: |
          const { triggerPayload, apiKey } = input;
          // è·å– Gateway è¯·æ±‚æ•°æ® - å·²ç»æ˜¯ JavaScript å¯¹è±¡
          const payload = triggerPayload;
          console.log("ğŸ“¥ Gateway è¯·æ±‚æ•°æ®:", JSON.stringify(payload, null, 2));
          
          // éªŒè¯ API Key
          const headers = payload.headers || {};
          console.log("ğŸ”‘ æ‰€æœ‰ headers:", JSON.stringify(headers, null, 2));
          console.log("ğŸ”‘ æ£€æŸ¥ X-API-Key:", headers['X-API-Key']);
          console.log("ğŸ”‘ æ£€æŸ¥ x-api-key:", headers['x-api-key']);
          console.log("ğŸ”‘ æ£€æŸ¥ X-Api-Key:", headers['X-Api-Key']);
          
          const receivedKey = headers['X-API-Key'] || headers['x-api-key'] || headers['X-Api-Key'] || '';
          const expectedKey = apiKey;
          
          console.log("ğŸ”‘ æ”¶åˆ°çš„ API Key:", receivedKey);
          console.log("ğŸ”‘ æœŸæœ›çš„ API Key:", expectedKey);
          
          if (receivedKey !== expectedKey) {
            throw new Error(`Invalid API Key: received '${receivedKey}', expected '${expectedKey}'`);
          }
          
          // è§£æè¯·æ±‚æ•°æ®
          const method = payload.method || '';
          const path = payload.path || '';
          
          // è§£æ body
          let body = {};
          let bodyStr = '';
          
          // å¤„ç† body æ•°æ®
          if (typeof payload.body === 'object' && payload.body !== null) {
            if (Array.isArray(payload.body)) {
              // å¦‚æœæ˜¯å­—ç¬¦æ•°ç»„ï¼Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²
              bodyStr = payload.body.join('');
            } else if (typeof payload.body === 'object') {
              // å¦‚æœæ˜¯å¯¹è±¡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰ string_value æˆ–å…¶ä»– protobuf å­—æ®µ
              bodyStr = payload.body.string_value || JSON.stringify(payload.body);
            }
          } else if (typeof payload.body === 'string') {
            // å¦‚æœå·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
            bodyStr = payload.body;
          }
          
          // å°è¯•è§£æä¸º JSON
          try {
            body = JSON.parse(bodyStr);
          } catch {
            // å¦‚æœè§£æå¤±è´¥ï¼Œä¿ç•™åŸå§‹å­—ç¬¦ä¸²
            body = bodyStr;
          }
          
          console.log("ğŸ“‹ è§£æåçš„è¯·æ±‚ä½“:", JSON.stringify(body, null, 2));
          
          // è§£æ query
          const query = payload.query || {};
          
          return {
            valid: true,
            method: method,
            path: path,
            body: body,
            query: query,
            receivedAt: new Date().toISOString()
          };

    # 3. æ ¹æ®è¯·æ±‚æ–¹æ³•å’Œè·¯å¾„å¤„ç†
    - name: "RouteRequest"
      type: "js"
      parameters:
        input: "={{ $P }}"  # æ¥æ”¶å‰ä¸€ä¸ªèŠ‚ç‚¹ParseRequestçš„è¾“å‡º
        code: |
          // inputç›´æ¥æ˜¯ParseRequestèŠ‚ç‚¹è¿”å›çš„ç»“æœï¼ŒåŒ…å«method, pathç­‰å±æ€§
          const request = input;
          
          // æ ¹æ®æ–¹æ³•å’Œè·¯å¾„è·¯ç”±
          if (request.method === 'POST' && request.path === '/api/v1/orders') {
            return {
              action: "create_order",
              data: request.body,
              route: "order_creation"
            };
          } else if (request.method === 'GET' && request.path === '/api/v1/status') {
            return {
              action: "check_status",
              orderId: request.query.orderId || "",
              route: "status_check"
            };
          } else {
            return {
              action: "unknown",
              route: "unknown",
              message: `Unknown request: ${request.method} ${request.path}`
            };
          }

    # 4a. å¤„ç†è®¢å•åˆ›å»º
    - name: "CreateOrder"
      type: "js"
      parameters:
        input: "={{ $P }}"  # æ¥æ”¶å‰ä¸€ä¸ªèŠ‚ç‚¹RouteRequestçš„è¾“å‡º
        code: |
          const orderData = input.data;
          
          // ç¡®ä¿orderDataæ˜¯å¯¹è±¡ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
          let orderDataObj = orderData;
          if (typeof orderData === 'string') {
            try {
              orderDataObj = JSON.parse(orderData);
            } catch (e) {
              console.error("âŒ è§£æè®¢å•æ•°æ®å¤±è´¥:", e);
              orderDataObj = {};
            }
          }
          
          // æ¨¡æ‹Ÿè®¢å•åˆ›å»ºé€»è¾‘
          const order = {
            id: `ORD-${Date.now()}`,
            ...orderDataObj,
            status: "pending",
            createdAt: new Date().toISOString()
          };
          
          console.log("ğŸ“¦ åˆ›å»ºè®¢å•:", JSON.stringify(order, null, 2));
          
          return {
            success: true,
            order: order,
            message: "Order created successfully"
          };

    # 4b. å¤„ç†çŠ¶æ€æŸ¥è¯¢
    - name: "CheckStatus"
      type: "js"
      parameters:
        input: "={{ $P }}"  # æ¥æ”¶å‰ä¸€ä¸ªèŠ‚ç‚¹RouteRequestçš„è¾“å‡º
        code: |
          const orderId = input.orderId;
          
          // æ¨¡æ‹ŸçŠ¶æ€æŸ¥è¯¢é€»è¾‘
          if (!orderId) {
            return {
              success: false,
              error: "Order ID is required"
            };
          }
          
          // æ¨¡æ‹Ÿè®¢å•çŠ¶æ€
          const status = {
            orderId: orderId,
            status: "processing",
            updatedAt: new Date().toISOString(),
            tracking: "TRK-123456"
          };
          
          console.log("ğŸ” æŸ¥è¯¢çŠ¶æ€:", JSON.stringify(status, null, 2));
          
          return {
            success: true,
            status: status
          };

    # 4c. å¤„ç†æœªçŸ¥è¯·æ±‚
    - name: "HandleUnknown"
      type: "js"
      parameters:
        input: "={{ $P }}"  # æ¥æ”¶å‰ä¸€ä¸ªèŠ‚ç‚¹RouteRequestçš„è¾“å‡º
        code: |
          const request = input;
          
          console.log("âš ï¸ æœªçŸ¥è¯·æ±‚:", request.message);
          
          return {
            success: false,
            error: request.message,
            code: 404
          };

    # 5. å‘é€åˆ°å¤–éƒ¨ API
    - name: "SendToAPI"
      type: "js"
      parameters:
        input:
          result: "={{ $P }}"
          targetUrl: "={{ $global.targetUrl }}"
        code: |
          const { result, targetUrl } = input;
          
          // æ¨¡æ‹Ÿå‘é€åˆ°å¤–éƒ¨ API
          console.log(`ğŸ“¤ å‘é€åˆ°å¤–éƒ¨ API: ${targetUrl}`);
          console.log("ğŸ“‹ å‘é€æ•°æ®:", JSON.stringify(result, null, 2));
          
          // æ¨¡æ‹Ÿ API å“åº”
          const apiResponse = {
            externalId: `EXT-${Date.now()}`,
            processedAt: new Date().toISOString(),
            ...result
          };
          
          return {
            apiResponse: apiResponse,
            sentToAPI: true
          };

    # 6. æ„å»ºå“åº”
    - name: "BuildResponse"
      type: "js"
      parameters:
        input: "={{ $P }}"  # æ¥æ”¶å‰ä¸€ä¸ªèŠ‚ç‚¹SendToAPIçš„è¾“å‡º
        code: |
          const finalResult = input;
          
          // æ„å»ºæœ€ç»ˆå“åº”
          let response = {
            success: finalResult.apiResponse?.success || false,
            message: finalResult.apiResponse?.message || "Request processed",
            timestamp: new Date().toISOString()
          };
          
          if (finalResult.apiResponse?.order) {
            response.order = finalResult.apiResponse.order;
          } else if (finalResult.apiResponse?.status) {
            response.status = finalResult.apiResponse.status;
          } else if (finalResult.apiResponse?.error) {
            response.error = finalResult.apiResponse.error;
          }
          
          console.log("ğŸ“¤ æœ€ç»ˆå“åº”:", JSON.stringify(response, null, 2));
          
          return response;

  connections:
    GatewayReceiver:
      - - { node: "ParseRequest" }
    ParseRequest:
      - - { node: "RouteRequest" }
    RouteRequest:
      # æ ¹æ®è¯·æ±‚ç±»å‹è·¯ç”±åˆ°ä¸åŒèŠ‚ç‚¹
      - - { node: "CreateOrder", when: [{ value1: "={{ $P.action }}", operation: "==", value2: "create_order" }] }
      - - { node: "CheckStatus", when: [{ value1: "={{ $P.action }}", operation: "==", value2: "check_status" }] }
      - - { node: "HandleUnknown", when: [{ value1: "={{ $P.action }}", operation: "==", value2: "unknown" }] }
    CreateOrder:
      - - { node: "SendToAPI" }
    CheckStatus:
      - - { node: "SendToAPI" }
    HandleUnknown:
      - - { node: "SendToAPI" }
    SendToAPI:
      - - { node: "BuildResponse" }
updatedAt: "2025-12-10T00:00:00.000Z"