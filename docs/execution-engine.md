# GFlow执行引擎

## 一、概述
GFlow执行引擎是系统的核心组件，负责工作流的执行管理、状态跟踪和控制流处理。引擎采用通用设计，支持前后端运行环境，实现了高效的工作流图遍历和节点执行协调。

## 二、核心组件

### 1. 通用工作流引擎 (`src/core/WorkflowEngine.ts`)
- **功能**: 处理图遍历、状态管理和控制流
- **特点**: 平台无关，可在浏览器和服务器环境中运行
- **核心算法**: BFS (广度优先搜索) 图遍历

### 2. 服务器端工作流引擎 (`src/server/engine.ts`)
- **功能**: 依赖CoreEngine并提供服务器特定上下文
- **特点**: 支持Node.js原生功能，如文件系统、网络请求、VM沙箱执行等
- **扩展**: 提供服务器端特有的节点运行器和执行环境
- **增强**: 实现了丰富的彩色日志输出系统，便于调试和监控

### 3. 客户端工作流执行器 (`src/runner.ts`, `src/worker/workflow.worker.ts`)
- **功能**: 在浏览器中执行工作流
- **特点**: 使用Web Worker进行后台执行，避免阻塞UI
- **限制**: 仅支持部分节点类型，受浏览器安全限制

## 三、工作流执行流程

1. **加载工作流定义**
   - 解析YAML格式的工作流定义
   - 验证工作流结构和节点配置
   - 构建工作流图结构

2. **初始化执行状态**
   - 创建执行上下文
   - 初始化节点结果存储
   - 设置全局变量和执行参数

3. **识别起始节点**
   - 查找类型为manual、webhook或timer的起始节点
   - 支持多个起始节点并行执行

4. **执行节点**
   - **获取运行器**: 根据节点类型获取对应的节点运行器
   - **准备上下文**: 构建节点执行上下文，包含工作流信息、全局变量、输入数据等
   - **执行逻辑**: 调用节点运行器的执行方法
   - **收集结果**: 记录节点执行结果、日志和输出数据

5. **处理连接**
   - **评估条件**: 根据连接规则评估是否执行下一个节点
   - **确定路径**: 根据条件评估结果确定下一个执行节点
   - **添加到队列**: 将符合条件的节点添加到执行队列

6. **重复执行**
   - 循环执行队列中的节点，直到所有可执行节点都执行完成
   - 处理分支、循环、条件等复杂控制流
   - 支持异常处理和错误恢复

## 四、执行状态管理

### 1. 执行状态结构
- **工作流状态**: isRunning, isPaused, waitingForInput
- **节点结果**: 记录每个节点的执行状态、开始时间、结束时间、日志等
- **执行日志**: 工作流级别的执行日志
- **全局变量**: 工作流执行过程中使用的全局变量

### 2. 控制模式
- **运行模式**: 连续执行所有可执行节点
- **单步模式**: 一次执行一个节点，执行后暂停
- **暂停/继续**: 支持执行过程中的暂停和继续操作

### 3. 输入等待机制
- 支持节点在执行过程中等待用户输入
- 提供输入配置和验证功能
- 输入完成后继续执行工作流

## 五、数据流管理

### 1. 变量系统
- **全局变量**: 工作流级别的共享变量
- **节点输入**: 节点执行时接收的输入数据
- **节点输出**: 节点执行后产生的输出数据

### 2. 变量插值
- 支持使用`={{ $P.variable }}`语法引用变量
- 支持嵌套变量和表达式
- 在节点执行前解析变量

### 3. 上下文传递
- 通过`NodeRunnerContext`在节点间传递数据
- 上下文包含工作流信息、执行状态、全局变量等
- 支持上下文的扩展和定制

## 六、日志和监控

### 1. 日志系统
- **节点日志**: 每个节点的执行日志
- **工作流日志**: 整个工作流的执行日志
- **时间戳**: 所有日志都包含时间戳信息

### 2. 监控功能
- **实时监控**: 实时显示工作流执行状态
- **进度跟踪**: 显示节点执行进度和结果
- **错误定位**: 快速定位执行错误的节点和原因

## 七、执行引擎特点

1. **通用设计**: 支持前后端运行环境
2. **高效遍历**: 使用BFS算法实现高效的工作流图遍历
3. **灵活控制**: 支持多种执行控制模式
4. **安全执行**: 支持节点在隔离环境中执行
5. **可扩展**: 支持自定义节点运行器和执行环境
6. **容错性**: 支持异常处理和错误恢复

## 八、代码结构
```
src/
├── core/
│   ├── WorkflowEngine.ts   # 通用工作流引擎
│   └── types.ts            # 核心类型定义
├── runner.ts               # 客户端工作流执行器
├── worker/
│   └── workflow.worker.ts  # Web Worker执行器
└── server/
    └── engine.ts           # 服务器端工作流引擎
```
