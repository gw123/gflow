# GFlow项目架构分析

## 一、项目概述
GFlow是一个基于Node.js和React的可视化工作流管理系统，支持工作流的创建、编辑、执行和监控。

## 二、前端架构

### 1. 技术栈
- **框架**: React 19 + TypeScript
- **构建工具**: Vite
- **可视化库**: ReactFlow (工作流图形化编辑)
- **状态管理**: Zustand
- **HTTP客户端**: 原生Fetch API
- **UI组件**: 自定义组件 + Lucide React图标库
- **数据格式**: YAML (工作流定义)

### 2. 核心模块

#### 2.1 应用入口 (`src/App.tsx`)
- 应用的主组件，集成了所有子组件和功能模块
- 管理工作流编辑器的核心状态和交互逻辑
- 协调各个面板、模态框和工具的显示与交互

#### 2.2 工作流编辑器
- 基于ReactFlow实现的可视化工作流编辑界面
- 支持节点拖拽、连接、删除和编辑
- 提供YAML视图和可视化视图的切换功能

#### 2.3 组件系统
- **核心组件**:
  - `EditorPanel`: 工作流编辑器主面板
  - `Sidebar`: 左侧节点库和工具面板
  - `YamlView`: YAML格式工作流定义视图
  - `ExecutionPanel`: 工作流执行监控面板
  - `CustomNode`: 自定义节点渲染组件
  - `HeaderToolbar`: 顶部工具栏
  - `ModalsManager`: 模态框管理组件

#### 2.4 状态管理 (`src/stores.ts`)
- 使用Zustand创建多个独立的状态存储：
  - `UIStore`: 管理UI状态，如模态框、面板的显示/隐藏
  - `UserStore`: 用户信息和认证状态
  - `WorkflowStore`: 工作流定义和编辑状态
  - `ExecutionStore`: 工作流执行状态和结果

#### 2.5 API客户端 (`src/api/client.ts`)
- 封装与后端API的交互逻辑
- 支持认证、工作流CRUD、执行、密钥管理等操作
- 处理请求/响应格式化和错误处理

#### 2.6 节点系统 (`src/nodes.ts`, `src/runners/`)
- 定义了多种内置节点类型（HTTP、JS、Time、Control等）
- 每个节点类型对应一个运行器（Runner），负责具体执行逻辑
- 支持节点参数配置、凭证关联和全局变量定义

### 3. 前端工作流执行
- 支持在浏览器中直接执行工作流（部分节点类型）
- 使用Web Worker进行后台执行，避免阻塞UI
- 提供执行监控、日志查看和断点调试功能

## 三、后端架构

### 1. 技术栈
- **框架**: Express.js
- **运行环境**: Node.js
- **调度系统**: node-cron
- **数据存储**: JSON文件（用于演示和开发）
- **安全**: VM沙箱（用于执行JavaScript节点）

### 2. 核心模块

#### 2.1 服务器入口 (`src/server/index.ts`)
- 初始化Express应用和中间件
- 配置CORS、路由和API端点
- 启动定时任务调度系统

#### 2.2 工作流引擎 (`src/core/WorkflowEngine.ts`, `src/server/engine.ts`)
- **CoreEngine**: 通用工作流引擎，处理图遍历、状态管理和控制流
- **ServerWorkflowEngine**: 服务器端工作流引擎，包装CoreEngine并提供服务器特定上下文
- 支持BFS图遍历、节点执行协调和状态管理

#### 2.3 调度系统
- 基于cron表达式的定时工作流触发
- 自动加载和调度包含定时器节点的工作流
- 支持动态添加/移除定时任务

#### 2.4 API服务
- 提供RESTful API接口，支持：
  - 工作流CRUD操作
  - 工作流执行和监控
  - 认证和用户管理
  - 密钥管理
  - API代理服务

#### 2.5 节点运行器 (`src/runners/`)
- 实现了多种服务器端节点运行器：
  - HTTP节点：发送HTTP请求
  - JavaScript节点：在VM沙箱中执行JS代码
  - 时间节点：定时器和延时功能
  - 控制节点：条件判断、循环等控制流
  - 默认节点：通用节点执行逻辑

#### 2.6 数据存储
- 使用JSON文件进行数据持久化（开发/演示环境）
- 支持的存储实体：
  - 工作流定义
  - 用户信息
  - 密钥凭证
  - API配置

## 四、核心模块和数据流

### 1. 工作流定义
- **格式**: YAML
- **核心元素**:
  - 节点（Nodes）: 工作流的执行单元
  - 连接（Connections）: 节点间的执行路径和条件
  - 参数（Parameters）: 节点的配置参数
  - 凭证（Credentials）: 访问外部服务的认证信息
  - 全局变量（Global）: 工作流级别的共享数据

### 2. 工作流执行流程
1. **加载工作流定义**
2. **初始化执行状态**
3. **识别起始节点**（manual、webhook、timer类型）
4. **执行节点**：
   - 获取节点对应的运行器
   - 准备执行上下文
   - 执行节点逻辑
   - 收集执行结果和日志
5. **处理连接**：
   - 评估连接条件
   - 确定下一个执行节点
6. **重复步骤4-5**，直到工作流执行完成或中断

### 3. 数据流
- **上下文传递**: 通过`NodeRunnerContext`在节点间传递数据
- **变量插值**: 支持使用`={{ $P.variable }}`语法引用变量
- **全局变量**: 支持在工作流级别定义和使用全局变量
- **节点输出**: 节点执行结果可以作为后续节点的输入

## 五、技术特点

### 1. 前后端分离
- 前端负责可视化编辑和用户交互
- 后端负责工作流执行和数据持久化
- 通过RESTful API进行通信

### 2. 插件化设计
- 节点系统采用插件化设计，支持动态扩展
- 每个节点类型有独立的运行器，便于维护和扩展
- 支持自定义节点类型和运行器

### 3. 可视化编程
- 通过ReactFlow实现工作流的可视化编辑
- 支持拖拽式节点添加和连接
- 提供实时预览和执行监控

### 4. 多环境支持
- 前端本地执行：部分节点类型支持在浏览器中直接执行
- 后端服务器执行：完整的工作流执行环境，支持所有节点类型
- 定时执行：基于cron表达式的定时工作流触发

### 5. 安全设计
- JavaScript节点在VM沙箱中执行，限制对系统资源的访问
- 密钥凭证安全存储，通过ID引用
- 支持认证和授权机制

## 六、项目结构

```
├── src/
│   ├── api/           # API客户端
│   ├── components/    # React组件
│   ├── core/          # 核心引擎和类型定义
│   ├── runners/       # 节点运行器
│   ├── server/        # 后端服务器
│   ├── services/      # 业务服务
│   ├── stores/        # Zustand状态存储
│   ├── worker/        # Web Worker
│   ├── App.tsx        # 应用主组件
│   ├── builtins.ts    # 内置节点定义
│   ├── constants.ts   # 常量定义
│   ├── nodes.ts       # 节点类型定义
│   ├── registry.ts    # 节点注册表
│   ├── runner.ts      # 工作流运行器
│   ├── tester.ts      # 测试工具
│   ├── types.ts       # TypeScript类型定义
│   └── utils.ts       # 工具函数
├── index.html         # HTML入口
├── index.tsx          # React应用入口
├── package.json       # 项目配置
├── tsconfig.json      # TypeScript配置
└── vite.config.ts     # Vite配置
```

## 七、总结

GFlow项目采用了现代化的前后端分离架构，结合了可视化编程和工作流管理的最佳实践。前端提供了直观易用的工作流编辑界面，后端提供了强大的工作流执行和管理能力。项目的插件化设计和模块化结构使其具有良好的扩展性和维护性，适合作为企业级工作流管理系统的基础框架。

### 架构优势
1. **可视化编程降低了使用门槛**，使非技术人员也能创建和管理工作流
2. **插件化设计支持灵活扩展**，可以根据业务需求添加新的节点类型
3. **前后端分离提高了开发效率**，便于团队协作和功能迭代
4. **多环境支持增强了系统的适用性**，可以根据不同场景选择合适的执行环境
5. **安全设计保障了系统的稳定性**，避免了恶意代码执行和数据泄露

### 改进建议
1. **数据存储优化**：考虑使用数据库（如MongoDB、PostgreSQL）替代JSON文件存储，提高数据可靠性和性能
2. **分布式执行**：支持工作流的分布式执行，提高系统的可扩展性和容错能力
3. **监控和告警**：增强工作流执行的监控和告警功能，便于及时发现和处理问题
4. **版本控制**：支持工作流定义的版本控制，便于回滚和历史记录查看
5. **用户权限**：完善用户权限管理，支持基于角色的访问控制
